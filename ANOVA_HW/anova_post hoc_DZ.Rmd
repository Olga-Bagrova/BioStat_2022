---
title: "ANOVA and post hoc"
author: "Багрова Ольга"
date: '2023-01-17'
output:
  html_document:
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
library(dplyr)
library(ggplot2)
library(multcomp)
library(sandwich)

# function for computing mean, DS, max and min values
min.mean.sd.max <- function(x) {
  r <- c(mean(x) - 3*sd(x), mean(x) - sd(x), mean(x), mean(x) + sd(x), mean(x) + 3*sd(x))
  names(r) <- c("ymin", "lower", "middle", "upper", "ymax")
  r
}
```


Загрузка данных

```{r}
soccer_general <- read.csv("soccer.csv", sep=";")[, 2:6] %>% 
    mutate(Position = as.factor(Position), 
    Nationality = as.factor(Nationality), 
    Age = as.numeric(Age), 
    Height = as.numeric(Height)
) %>% 
filter(Nationality %in% c("Spanish", "Italian", "German", "English", "Argentinian")) 

set.seed(1) 

soccer_wrk <- soccer_general[sample(1:nrow(soccer_general), 150), ] %>% 
    mutate(Nationality = factor(Nationality))
```




#Рост и позиция футболиста



##Дисперсионный анализ (ANOVA)


Посмотрим на данные

```{r}
ggplot(aes(y = Height, x = Position), data = soccer_wrk) +
  ylim(155, 210) + 
  ggtitle("Boxplot: mean + sd") + 
  xlab("Position") + 
  ylab("Height (cm)") +
  theme_classic() +
  stat_summary(fun.data = min.mean.sd.max, geom = "boxplot",
               colour = "cadetblue3") +
  geom_hline(yintercept = mean(soccer_wrk$Height),
             lwd = 1,
             colour = "salmon2") +
  geom_jitter(colour = "cornsilk4", position=position_jitter(width=.2))
```


ANOVA (классическая)

```{r}
aov(Height ~ Position, data = soccer_wrk) %>% summary
```

Велш

```{r}
oneway.test(Height ~ Position, data = soccer_wrk)
```


**В данном случае результаты классического F-теста и F-теста Велша дают p-value<0.05. Отвергаем нулевую гипотезу о равенстве значений среднего роста для каждой позиций футболистов (или о том, что рост и позиция футболиста не связаны), т.е. какая-то связь между позицией и средним ростом есть (хотя бы одна пара средних значений роста не равна).**



##Процедура Хоторна-Бретца-Вестфалла (post hoc)


Получим p-value

```{r}
m0 <- lm(Height ~ Position, data = soccer_wrk)
HBW.comp <- m0 %>%  glht(linfct = mcp(Position = "Tukey"))
HBW.comp %>% summary()
```

Получим доверительные интервалы

```{r}
HBW.comp %>% confint()
```

```{r}
par(mar = c(5, 10, 4, 2)+0.1)
HBW.comp %>% plot(xlab = "Height difference (cm)")
```
**На предыдущем шаге мы отвергли H0 о том, что все значения среднего роста равны для разных позиций футболистов. В данном случае видим детально какие именно пары средних не равны. По p-value (<0.05) и по ДИ (не включают 0) видим, что средний рост не равен для следующиъ пар позиций: Goalkeeper - Defender, Midfielder - Defender, Goalkeeper - Forward, Midfielder - Goalkeeper. В случае пар Forward - Defender, Midfielder - Forward не можем отвергунть нулевую гипотезу о равенстве их средних значений роста.**



Для гетероскедастичных данных (посмотрим разницу)

```{r}
HBW.comp.hetero <- m0 %>%  glht(linfct = mcp(Position = "Tukey"), 
                                vcov = vcovHC(m0, type = "HC4"))
HBW.comp %>% summary
HBW.comp %>% confint
HBW.comp.hetero %>% plot(xlab = "Height difference (cm)")
```

Значения p-value и доверительных интервалов близки к предыдущим значениям (ДИ немного шире). Вывод аналогичен предыдущему.


**В предыдущем домашнем задании гипотезу H0 не могли отвергнуть для пар: Forward - Defender, Midfielder - Forward. В данном случае мы получили такие же результаты.**




#Рост и страна футболиста



##Дисперсионный анализ (ANOVA)


Посмотрим на данные

```{r}
ggplot(aes(y = Height, x = Nationality), data = soccer_wrk) +
  ylim(155, 210) + 
  ggtitle("Boxplot: mean + sd") + 
  xlab("Nationality") + 
  ylab("Height (cm)") +
  theme_classic() +
  stat_summary(fun.data = min.mean.sd.max, geom = "boxplot",
               colour = "cadetblue3") +
  geom_hline(yintercept = mean(soccer_wrk$Height),
             lwd = 1,
             colour = "salmon2") +
  geom_jitter(colour = "cornsilk4", position=position_jitter(width=.2))
```


Всего возможных пар 10.

ANOVA (классическая)

```{r}
aov(Height ~ Nationality, data = soccer_wrk) %>% summary
```

Велш

```{r}
oneway.test(Height ~ Nationality, data = soccer_wrk)
```


**В данном случае результаты классического F-теста и F-теста Велша дают близкие друг к другу p-value>0.05. Не отвергаем нулевую гипотезу о равенстве значений среднего роста для стран футболистов (или о том, что рост и страна футболиста не связаны).**



##Процедура Хоторна-Бретца-Вестфалла (post hoc)


Получим p-value

```{r}
m0 <- lm(Height ~ Nationality, data = soccer_wrk)
HBW.comp <- m0 %>%  glht(linfct = mcp(Nationality = "Tukey"))
HBW.comp %>% summary()
```

Получим доверительные интервалы

```{r}
HBW.comp %>% confint()
```

```{r}
par(mar = c(5, 10, 4, 2)+0.1)
HBW.comp %>% plot(xlab = "Height difference (cm)")
```
**На предыдущем шаге мы не отвергли H0 о том, что все значения среднего роста равны для разных стран футболистов. В данном случае видим детально, что все пары по p-value (>0.05) и по ДИ (включают 0), говорят что средний рост не связан со страной, за которую играет футболист.**
