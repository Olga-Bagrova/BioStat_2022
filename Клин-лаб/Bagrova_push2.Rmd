---
title: 'ДЗ: Клинико-лабораторная диагностика'
author: "Багрова Ольга"
date: '2022-11-07'
output:
  html_document:
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

```{r include=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(pROC)
library(gtsummary)
```



#Загрузка данных
```{r}
data <- read.csv("diabetes.csv")
data %>% glimpse()
```
Описание датасета pima (diabetes.csv):
• Pregnancies – количество беременностей в анамнезе (кол-во);
• Glucose – уровень глюкозы на 120 минуте орального глюкозотолерантного теста (мг/дл);
• BloodPressure – диастолическое артериальное давление (мм рт.ст.);
• SkinThickness – толщина кожной складки на трицепсе (мм),
• Insulin – уровень инсулина (мЕ/мл);
• BMI – индекс массы тела (кг/м2);
• DiabetesPedigreeFunction – индекс, отражающий вероятность наличия диабета на основании наследственного анамнеза;
• Age – возраст (лет);
• Outcome – наличие сахарного диабета (0 – нет, 1 – да);

Подправим тип Outcome на факторный.
```{r}
data$Outcome <- as.factor(data$Outcome)
```


Заменим нули в столбцах на NA: Glucose, BloodPressure, SkinThickness, Insulin, BMI.

```{r}
data <- data %>%
  mutate_at(c("Glucose", "BloodPressure", "SkinThickness", "Insulin", "BMI"), ~na_if(., 0))
```


#1
У какого количества пациентов из датасета присутствует нарушенная толерантность к глюкозе (НТГ)? Критерий НТГ – это уровень повышение гликемии ≥ 7.8 ммоль/л на 120 минуте теста на толерантность к глюкозе. Сколько в датасете пациентов, у которых нет НТГ?
*Для уровня глюкозы 1 ммоль / л = 18 мг/дл (в нашем датасете глюкоза в мг/дл)

```{r}
#Добавлен ответ на вопрос у скольких пациентов есть НТГ
Treshold <- 7.8*18 #из ммоль/л в мг/дл

data %>%
  filter(Glucose <= Treshold)%>%
  nrow(.)#НТГ есть

data %>%
  filter(Glucose > Treshold)%>%
  nrow(.)#НТГ нет

sum(is.na(data$Glucose))
```
*У 571 есть и у 192 пациентов нет НТГ.* (по 5 пациентам нет данных)

#2
Как выглядит ROC-кривая для предсказания сахарного диабета по переменной, характеризующей уровень гликемии?

```{r}
roc(Outcome ~ Glucose, data = data) %>%
  ggroc() +
  theme_bw()
```

#3
Чему равна площадь под ROC-кривой из вопроса 2?
```{r}
roc_curve_G <- roc(Outcome ~ Glucose, data = data)

roc_curve_G
```
*Площадь под ROC-кривой равна 0.7928.*

#4
Чему равен 95% двусторонний ДИ для площади под ROC-кривой из вопроса 2?

```{r}
roc_curve_G <- roc(Outcome ~ Glucose, data = data, ci = T)

roc_curve_G
```
*95% двусторонний ДИ для площади под ROC-кривой из вопроса 2 равен [0.7599;0.8257].*

#5
Постройте ROC-кривую и определите, какое пороговое значение является оптимальным для предсказания сахарного диабета по уровню инсулина? Какой чувствительностью и специфичностью обладает данный порог?
```{r}
roc_curve_I <- roc(Outcome ~ Insulin, data = data, ci = T)

roc_curve_I

ggroc(roc_curve_I) + 
    theme_bw()

roc_curve_I %>% coords(x = "best", best.method = "closest.topleft")

```
*Пороговое значение является 121 (специфичность = 0.62; чувствительность = 0.78).* 
У контролей значение ниже, т.е. повышение инсулина плохо для пациента.

#6
Какая из количественных переменных в датасете обладает наибольшей площадью под ROC-кривой? Как вы можете интерпретировать это знание? Какая количественная переменная имеет наименьшую площадь?

```{r message=FALSE, warning=FALSE}
res<-data %>%
  pivot_longer(cols = !Outcome) %>%
  group_by(name) %>%
  summarise(AUC = roc(Outcome, value, ci = T)$ci[2] %>% round(3),
              AUC_LCL = roc(Outcome, value, ci = T)$ci[1] %>% round(3),
              AUC_UCL = roc(Outcome, value, ci = T)$ci[3] %>% round(3))
print(res[order(-res$AUC),])
```
*Наибольшей площадью под ROC-кривой обладает уровень гликемии. Поскольку при заболевании сахарным диабетом нарушается усваивание глюкозы, т.е. заболевание и показатель напрямую связаны, то он является успешным диагностическим методом данного заболевания.*
*Следующим идёт инсулин. Известно, что при сахарном диабете нарушена выработка инсулина или орагнизма чувствительность к нему. Поэтому этот показатель тоже полезен в диагностике заболевания.*

*Наименьшей площадью под ROC-кривой обладают DiabetesPedigreeFunction (индекс, отражающий вероятность наличия диабета на основании наследственного анамнеза) и кровяное давление. Кровяное давление может изменяться не только по причине заболевания сахарным диабетом, и не обязательно изменяться при данном недуге. Что касается DiabetesPedigreeFunction, то он отражает риск развития заболевания, но не всегда человек с высоким риском заболеет. Может быть и такое, что человек знает, что у него есть риск заболеть и он старается предотвратить это (здоровое питание и т.п.) и болезнь не развивается, так что в рамках диагностики этот показатель может быть не сильно полезен.*
